<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cart | GritDash</title>
    <link rel="stylesheet" href="homepage-style.css">
    <script src="https://kit.fontawesome.com/5d92ce3398.js" crossorigin="anonymous"></script>
    <style>
      /* Minimal page-specific styling */
      td{ font-family:Arial, Helvetica, sans-serif; font: arial; font-size: 14px; }
      th{ font-family:Arial, Helvetica, sans-serif; font: arial; font-size: 14px; font-weight: bold; }
      .cart-title { font-size: 22px; font-weight: bold; font-family: Arial, Helvetica, sans-serif; font: arial; }
      .cart-container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
      .cart-list { width: 100%; border-collapse: collapse; }
      .cart-list th, .cart-list td { padding: 0.75rem; border-bottom: 1px solid #e0e0e0; text-align: left; }
      .cart-actions { display:flex; gap:1rem; justify-content:flex-end; margin-top:5rem; }
      .empty { text-align:center; color:#666; margin: 2rem 0; }
      .badge { position: relative; }
      .cart-total { text-align:right; font-weight:700; margin-top:1rem; font-size:1.1rem; font-family:Arial, Helvetica, sans-serif; font: arial}
      .btn { background:#2b6cb0; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; }
      .btn.secondary { background:#e53e3e; }
      .btn.secondary:hover { background:rgb(250, 88, 88); }
      .remove-button { background-color:rgb(255, 212, 212); border:1px solid #ddd; padding:6px 8px; border-radius:4px; cursor:pointer; transition: background-color .15s ease;}
      .remove-button:hover { background-color: rgb(255, 155, 155);}

      @media screen and (max-width: 450px){
        .cart-container{
          width: 80%;
          min-height: 100vh;
          height: 100%;
        }
        .cart-actions{
          margin-top: 1rem;
          
        }
        .btn{
          width: 120px;
          height: 50px;
          font-size: 16px;
        }
      }
    </style>
  </head>
  <body>
    <header class="nav-bar">
      <div class="header-container">
        <a href="homepage.html" style="text-decoration:none;"><img class="nav-logo" src="./images/gritdash-logo-1.png" alt="GritDash logo"></a>
        <i class="fa-solid fa-bars menu-icon"></i>
        <div class="header-dropdown hidden">
          <a class="dropdown-selection" href="homepage.html">Home</a>
          <a class="dropdown-selection" href="worker-portal.html">Worker Portal</a>
          <a class="dropdown-selection" href="restaurant-staff-portal.html">Restaurant Staff</a>
          <a class="dropdown-selection" href="admin.html">Admin Portal</a>
        </div>
        <a class="nav-link" href="homepage.html">Home</a>
        <a class="nav-link" href="worker-portal.html">Worker Portal</a>
        <a class="nav-link" href="restaurant-staff-portal.html">Restaurant Staff</a>
        <a class="nav-link" href="admin.html">Admin Portal</a>
      </div>
      <a href="cart.html" aria-label="Cart" class="cart-anchor">
        <i class="fa-solid fa-cart-shopping badge"></i>
        <p id="cart-count" class="badge-count">0</p>
      </a>
      <script src="./scripts/cart-common.js"></script>
    </header>

    <main class="cart-container">
      <p class="cart-title">Your Cart</p>

      <div id="cart-area">
        <p class="empty" id="empty-msg">Your cart is empty. Start ordering from the restaurants!</p>

        <table class="cart-list" id="cart-table" style="display:none">
          <thead>
            <tr>
              <th>Restaurant</th>
              <th>Item</th>
              <th>Price</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="cart-body"></tbody>
        </table>

        <div id="cart-footer" style="display:none">
          <div class="cart-total" id="cart-total"></div>
          <div class="cart-actions">
            <button id="clear-cart" class="btn secondary">Clear Cart</button>
            <button id="past-orders-footer" class="btn">Past Orders</button>
            <button id="checkout" class="btn">Proceed to Checkout</button>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <img class="footer-logo" src="./images/gritdash-logo-1.png">
    </footer>

    <script src="./scripts/cart-common.js"></script>
    <script>
      async function renderCart() {
        const table = document.getElementById('cart-table');
        const body = document.getElementById('cart-body');
        const emptyMsg = document.getElementById('empty-msg');
        const footer = document.getElementById('cart-footer');
        const totalEl = document.getElementById('cart-total');

        const cart = await getCart();

        if (!cart || !cart.items || !cart.items.length) {
          table.style.display = 'none';
          emptyMsg.style.display = 'block';
          // keep footer visible so Past Orders button is always accessible
          footer.style.display = 'block';
          try { document.getElementById('clear-cart').style.display = 'none'; } catch(e) {}
          try { document.getElementById('checkout').style.display = 'none'; } catch(e) {}
          try { document.getElementById('past-orders-footer').style.display = 'inline-block'; } catch(e) {}
          try { document.getElementById('cart-total').style.display = 'none'; } catch(e) {}
          updateCartBadge();
          return;
        }

        emptyMsg.style.display = 'none';
        table.style.display = 'table';
        footer.style.display = 'block';
        body.innerHTML = '';

        let total = 0;
        for (const item of cart.items) {
          const tr = document.createElement('tr');
          const price = parseFloat(item.Price || 0) * (item.Quantity || 1);
          total += price;
          const menuItem = await getMenuItem(item.ItemID);
          tr.innerHTML = `
            <td>${escapeHtml(menuItem.restaurant.Name || '')}</td>
            <td>${escapeHtml(menuItem.Name || '')}${item.Quantity && item.Quantity > 1 ? ' <small>Ã—' + item.Quantity + '</small>' : ''}</td>
            <td>$${price.toFixed(2)}</td>
            <td><button class="remove-button" data-item-id="${item.ItemID}" data-quantity="1">Remove</button></td>
          `;
          body.appendChild(tr);
        }

        totalEl.textContent = 'Total: $' + total.toFixed(2);
        updateCartBadge();

        // attach remove handlers
        document.querySelectorAll('.remove-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const itemId = e.currentTarget.getAttribute('data-item-id');
            const qty = parseInt(e.currentTarget.getAttribute('data-quantity') || '1', 10);
            removeItem(itemId, qty);
          });
        });
      }

      async function removeItem(itemId, quantity) {
        // removeFromCart dispatches 'cart_updated' when complete which triggers renderCart.
        // Avoid calling renderCart() here directly to prevent overlapping renders.
        await removeFromCart({ id: itemId, quantity: quantity || 1 });
      }

      async function clearCart() {
        const customer = localStorage.getItem('current_customer')
        const customerParsed = JSON.parse(customer);
        if (!confirm('Are you sure you want to clear your cart?')) return;
        await fetch('/api/cart', { method: 'DELETE',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ id: customerParsed.CustomerID})});
        renderCart();
      }

      function escapeHtml(text) {
        return text.replace(/[&<>"']/g, function (m) {
          return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
        });
      }

      document.getElementById('clear-cart').addEventListener('click', clearCart);
      document.getElementById('checkout').addEventListener('click', () => {
        // Always proceed to checkout page (no forced sign-in from cart)
        window.location.href = 'checkout.html';
      });

      function goToPastOrders(){
        const currentCustomer = localStorage.getItem('current_customer');
        if (!currentCustomer) {
          window.location.href = 'customer-login.html?redirect=past-orders.html';
          return;
        }
        window.location.href = 'past-orders.html';
      }

      // bind handler to footer Past Orders button
      const btnFooter = document.getElementById('past-orders-footer');
      if (btnFooter) btnFooter.addEventListener('click', goToPastOrders);

      // custom event for same-tab updates
      window.addEventListener('cart_updated', () => renderCart());

      // initial render
      renderCart();
      
    </script>
    <script src="./scripts/dropdown-menu.js"></script>

  </body>
</html>