<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Worker Dashboard | GritDash</title>
    <link rel="stylesheet" href="homepage-style.css">
    <style>
      .dashboard { max-width:900px;margin:2rem auto;padding:1rem; position: relative; }
      .order { border:1px solid #e6e6e6;padding:0.75rem;margin-bottom:0.75rem;border-radius:6px;}
      .order h4{margin:0 0 0.5rem 0}
      .btn{background:#2b6cb0;color:#fff;padding:6px 10px;border-radius:4px;border:none;cursor:pointer}
      .status-badge { display:inline-block;padding:4px 12px;border-radius:12px;font-size:13px;font-weight:600;margin-left:8px; }
      .status-available { background:#48bb78;color:#fff; }
      .status-unavailable { background:#a0aec0;color:#fff; }
      .status-on-delivery { background:#ed8936;color:#fff; }
      .availability-control { display:flex;align-items:center;gap:10px;margin:1rem 0;padding:1rem;background:#f7fafc;border-radius:6px; }
      .toggle-switch { position:relative;display:inline-block;width:50px;height:24px; }
      .toggle-switch input { opacity:0;width:0;height:0; }
      .toggle-slider { position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#cbd5e0;border-radius:24px;transition:.3s; }
      .toggle-slider:before { position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:white;border-radius:50%;transition:.3s; }
      input:checked + .toggle-slider { background-color:#48bb78; }
      input:checked + .toggle-slider:before { transform:translateX(26px); }
      input:disabled + .toggle-slider { opacity:0.5;cursor:not-allowed; }

      @media screen and (max-width: 450px){
        .dashboard{
          width: 350px;
          margin: 10px;
          font-family:Arial, Helvetica, sans-serif;
          font: arial;
        }

        .availability-control{
          width: 350px;
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <header class="nav-bar">
            <div class="header-container">
                <img class="nav-logo" src="./images/gritdash-logo-1.png" alt="GritDash logo">
                <i class="fa-solid fa-bars menu-icon"></i>
                <div class="header-dropdown hidden">
                    <a class="dropdown-selection" href="homepage.html">Home</a>
                    <a class="dropdown-selection" href="worker-portal.html">Worker Portal</a>
                    <a class="dropdown-selection" href="restaurant-staff-portal.html">Restaurant Staff</a>
                    <a class="dropdown-selection" href="admin.html">Admin Portal</a>
                </div>
                <a class="nav-link" href="homepage.html">Home</a>
                <a class="nav-link" href="worker-portal.html">Worker Portal</a>
                <a class="nav-link" href="restaurant-staff-portal.html">Restaurant Staff</a>
                <a class="nav-link" href="admin.html">Admin Portal</a>
            </div>
            <a href="cart.html" aria-label="Cart" class="cart-anchor">
                <i class="fa-solid fa-cart-shopping badge"></i>
                <p id="cart-count" class="badge-count">0</p>
            </a>
        <script src="./scripts/cart-common.js"></script>
        
        </header>

    <main class="dashboard">
      <h2>Worker Dashboard</h2>
      <p id="worker-info"></p>

      <div class="availability-control">
        <label style="font-weight:600;">Availability Status:</label>
        <span id="status-badge" class="status-badge">Loading...</span>
        <label class="toggle-switch">
          <input type="checkbox" id="availability-toggle">
          <span class="toggle-slider"></span>
        </label>
        <span id="toggle-label">Available</span>
        <div style="flex:1;"></div>
        <button id="signout" class="btn" style="background:#e53e3e">Sign Out</button>
      </div>

      <h3>Available Orders</h3>
      <div id="orders-list">Loading pending orders...</div>
      <h3 style="margin-top:1.5rem">Your Active Jobs</h3>
      <div id="active-jobs">Loading active jobs...</div>
      <h3 style="margin-top:1.5rem">Customer Feedback</h3>
      <div id="feedback-list">Loading feedback...</div>
    </main>

    <footer><img class="footer-logo" src="./images/gritdash-logo-1.png"></footer>

    <script>
      const currentWorker = JSON.parse(localStorage.getItem('current_worker')||'null');
      const ordersList = document.getElementById('orders-list');
      const workerInfo = document.getElementById('worker-info');
      const statusBadge = document.getElementById('status-badge');
      const availabilityToggle = document.getElementById('availability-toggle');
      const toggleLabel = document.getElementById('toggle-label');

      if(!currentWorker){ window.location.href='worker-signin.html'; }
      else { workerInfo.textContent = `Signed in as ${currentWorker.Name} (${currentWorker.WorkerID})`; }

      document.getElementById('signout').addEventListener('click', ()=>{
        localStorage.removeItem('current_worker');
        window.location.href = 'worker-signin.html';
      });

      // Fetch and display current worker availability status
      async function updateWorkerStatus(){
        try{
          const res = await fetch(`/api/workers/${currentWorker.WorkerID}`);
          if(!res.ok) throw new Error('Failed to fetch worker status');
          const data = await res.json();
          const worker = data.worker;
          const status = worker.AvailabilityStatus || 'Available';

          // Update currentWorker in localStorage
          currentWorker.AvailabilityStatus = status;
          localStorage.setItem('current_worker', JSON.stringify(currentWorker));

          // Update UI
          updateStatusUI(status);
        }catch(e){
          console.error('Error fetching worker status:', e);
        }
      }

      // Update status badge and toggle based on current status
      function updateStatusUI(status){
        // Update badge
        statusBadge.textContent = status;
        statusBadge.className = 'status-badge';
        if(status === 'Available'){
          statusBadge.classList.add('status-available');
          availabilityToggle.checked = true;
          availabilityToggle.disabled = false;
          toggleLabel.textContent = 'Available';
        }else if(status === 'Unavailable'){
          statusBadge.classList.add('status-unavailable');
          availabilityToggle.checked = false;
          availabilityToggle.disabled = false;
          toggleLabel.textContent = 'Unavailable';
        }else if(status === 'On Delivery'){
          statusBadge.classList.add('status-on-delivery');
          availabilityToggle.checked = true;
          availabilityToggle.disabled = true;
          toggleLabel.textContent = 'On Delivery';
        }
      }

      // Handle availability toggle
      availabilityToggle.addEventListener('change', async ()=>{
        const newStatus = availabilityToggle.checked ? 'Available' : 'Unavailable';
        try{
          const res = await fetch(`/api/workers/${currentWorker.WorkerID}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ AvailabilityStatus: newStatus })
          });
          if(!res.ok) throw new Error('Failed to update status');
          await updateWorkerStatus();
          // Reload orders to reflect availability filter
          loadOrders();
        }catch(e){
          console.error('Error updating availability:', e);
          alert('Failed to update availability status');
          // Revert toggle
          availabilityToggle.checked = !availabilityToggle.checked;
        }
      });

      // small helper to escape user-provided text when inserting into innerHTML
      function escapeHtml(unsafe){
        if(!unsafe && unsafe !== 0) return '';
        return String(unsafe)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

  async function loadOrders(){
        try{
          // Check worker availability status
          const workerStatus = currentWorker.AvailabilityStatus || 'Available';
          if(workerStatus === 'Unavailable'){
            ordersList.innerHTML = '<p>You are currently unavailable. Toggle your availability to see orders.</p>';
            return;
          }

          const res = await fetch('/api/orders/placed');
          if(!res.ok) throw new Error('Failed to load');
          const data = await res.json();
          const orders = data.orders || [];
          if(!orders.length){ ordersList.innerHTML = '<p>No pending orders right now.</p>'; return; }
          ordersList.innerHTML = '';
          for (const o of orders) {
            const div = document.createElement('div'); div.className='order';
            // build items html with item names
            let itemsHtml = '';
            for (const it of o.items) {
              try{
                const menuItem = (typeof window.getMenuItem === 'function') ? await window.getMenuItem(it.ItemID) : null;
                const name = menuItem ? menuItem.Name : it.ItemID;
                itemsHtml += `${it.Quantity}× ${name} — $${(it.Price||0).toFixed? (it.Price||0).toFixed(2) : (it.Price||0)}<br>`;
              }catch(e){ itemsHtml += `${it.Quantity}× ${it.ItemID} — $${it.Price}<br>`; }
            }
            const instructions = (o.delivery && (o.delivery.instructions || o.delivery.room)) ? { text: o.delivery.instructions||'', room: o.delivery.room||'' } : null;
            div.innerHTML = `<h4>Order ${o.OrderID} — $${(o.TotalCost||o.TotalCost===0? (o.TotalCost.toFixed? o.TotalCost.toFixed(2):o.TotalCost) : '')}</h4>
              <div><strong>Restaurant:</strong> ${o.restaurant? o.restaurant.Name : o.RestaurantID}</div>
              <div><strong>Items:</strong><div>${itemsHtml}</div></div>
              <div><strong>Deliver to:</strong> ${(o.delivery && o.delivery.building) || o.DeliveryLocation} ${(o.delivery && o.delivery.room) || ''}</div>
              <div><strong>Instructions:</strong> ${instructions && instructions.text ? escapeHtml(instructions.text) : 'None'}</div>
              ${instructions && instructions.room ? `<div><strong>Room/Location:</strong> ${escapeHtml(instructions.room)}</div>` : ''}
              <div><strong>Tip:</strong> $${o.Tip || 0}</div>
              <div style="margin-top:0.5rem">
                <button class="btn js-accept" data-id="${o.OrderID}">Accept</button>
                <button class="btn js-decline" data-id="${o.OrderID}" style="background:#a0aec0;margin-left:8px">Decline</button>
              </div>`;
            ordersList.appendChild(div);
          }

          document.querySelectorAll('.js-accept').forEach(btn => {
            btn.addEventListener('click', async (e)=>{
              const orderId = btn.dataset.id;
              const body = { workerId: currentWorker.WorkerID };
              const resp = await fetch(`/api/orders/${orderId}/accept`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
              if(!resp.ok){ alert('Failed to accept order'); return; }
              const d = await resp.json();
              const jobId = d.jobId;
              // show pickup and delivery guidance
                const order = (await (await fetch('/api/orders/placed')).json()).orders.find(x=>x.OrderID===orderId);
                const pickup = order && order.restaurant ? order.restaurant.Location : 'Restaurant pickup location';
                alert(`Order accepted. Pickup at: ${pickup}. Deliver to: ${order.delivery && order.delivery.building} ${order.delivery && order.delivery.room || ''}`);
                // Optimistically move the order from pending to active jobs immediately for snappy UX
                try{
                  // remove pending element from DOM
                  const pendingEl = btn.closest('.order');
                  if(pendingEl) pendingEl.remove();
                  // create minimal job object and render into Active Jobs
                  const optimisticJob = { JobID: jobId, OrderID: order.OrderID, order: order, items: order.items };
                  appendActiveJobToDOM(optimisticJob);
                }catch(e){ console.error('Optimistic UI update failed', e); }
                // sync with server in background
                updateWorkerStatus();
                loadActiveJobs();
                loadOrders();
                loadWorkerFeedback();
            });
          });
          document.querySelectorAll('.js-decline').forEach(btn => {
            btn.addEventListener('click', async () => {
              const orderId = btn.dataset.id;
              const body = { workerId: currentWorker.WorkerID };
              const resp = await fetch(`/api/orders/${orderId}/decline`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
              if(!resp.ok){ alert('Failed to record decline'); return; }
              // remove the order element from the list
              btn.closest('.order').remove();
            });
          });
        }catch(e){ console.error(e); ordersList.innerHTML = '<p>Error loading orders</p>'; }
      }

      // handle completing job via query param
      async function maybeCompleteJob(){
        const params = new URLSearchParams(window.location.search);
        const job = params.get('job');
        if(job){
          const done = confirm('Mark this job as delivered and finish?');
          if(done){
            const r = await fetch(`/api/jobs/${job}/complete`, { method: 'POST' });
            if(r.ok){ alert('Job marked completed. Nice work!'); window.history.replaceState({}, '', 'worker.html'); await updateWorkerStatus(); await loadOrders(); await loadActiveJobs(); }
            else alert('Failed to mark completed');
          } else { window.history.replaceState({}, '', 'worker.html'); }
        }
      }

      async function loadActiveJobs(){
        try{
          const activeEl = document.getElementById('active-jobs');
          const res = await fetch(`/api/jobs/worker/${currentWorker.WorkerID}`);
          if(!res.ok) throw new Error('Failed to load active jobs');
          const data = await res.json();
          const jobs = data.jobs || [];
          if(!jobs.length){ activeEl.innerHTML = '<p>No active jobs right now.</p>'; return; }
          activeEl.innerHTML = '';
          for(const job of jobs){
            const div = document.createElement('div'); div.className = 'order';
            const order = job.order || {};
            let itemsHtml = '';
            for(const it of job.items || []){
              try{
                const menuItem = (typeof window.getMenuItem === 'function') ? await window.getMenuItem(it.ItemID) : null;
                const name = menuItem ? menuItem.Name : it.ItemID;
                itemsHtml += `${it.Quantity}× ${name} — $${(it.Price||0).toFixed? (it.Price||0).toFixed(2) : (it.Price||0)}<br>`;
              }catch(e){ itemsHtml += `${it.Quantity}× ${it.ItemID} — $${it.Price}<br>`; }
            }
            const delivery = order.delivery || {};
            div.innerHTML = `<h4>Job ${escapeHtml(job.JobID)} — Order ${escapeHtml(order.OrderID || job.OrderID || '')}</h4>
              <div><strong>Restaurant:</strong> ${order.restaurant ? escapeHtml(order.restaurant.Name) : ''}</div>
              <div><strong>Items:</strong><div>${itemsHtml}</div></div>
              <div><strong>Deliver to:</strong> ${escapeHtml(delivery.building || order.DeliveryLocation || '')} ${escapeHtml(delivery.room || '')}</div>
              <div><strong>Instructions:</strong> ${delivery.instructions ? escapeHtml(delivery.instructions) : 'None'}</div>
              <div style="margin-top:0.5rem"><button class="btn js-complete" data-id="${escapeHtml(job.JobID)}">Mark Delivered</button></div>`;
            activeEl.appendChild(div);
          }

          document.querySelectorAll('.js-complete').forEach(btn => {
            btn.addEventListener('click', async () => {
              const jobId = btn.dataset.id;
              if(!confirm('Confirm you have delivered this order?')) return;
              const r = await fetch(`/api/jobs/${jobId}/complete`, { method: 'POST' });
              if(r.ok){ alert('Job completed.'); await updateWorkerStatus(); await loadActiveJobs(); await loadOrders(); }
              else alert('Failed to complete job');
            });
          });
        }catch(e){ console.error(e); document.getElementById('active-jobs').innerHTML = '<p>Error loading active jobs</p>'; }
      }

      // Load feedback left by customers for jobs this worker completed
      async function loadWorkerFeedback(){
        try{
          const fbEl = document.getElementById('feedback-list');
          fbEl.innerHTML = 'Loading feedback...';
          // fetch worker jobs (to ensure feedbacks belong to this worker)
          const jobsResp = await fetch(`/api/jobs/worker/${currentWorker.WorkerID}`);
          const jobsData = jobsResp && jobsResp.ok ? await jobsResp.json().catch(()=>({jobs:[]})) : { jobs: [] };
          const jobOrderIds = new Set((jobsData.jobs || []).map(j => (j.OrderID || (j.order && j.order.OrderID))));

          const res = await fetch(`/api/workers/${currentWorker.WorkerID}/feedback`);
          if(!res.ok){ fbEl.innerHTML = '<p>Failed to load feedback</p>'; return; }
          const data = await res.json();
          const feedbacks = data.feedbacks || [];
          // Filter feedbacks to only those that correspond to orders this worker handled (defensive)
          const filtered = feedbacks.filter(f => jobOrderIds.has(f.OrderID));
          if (filtered.length !== feedbacks.length) console.debug('Filtered out feedback entries not belonging to this worker', feedbacks.map(f=>f.OrderID), Array.from(jobOrderIds));
          if(!filtered.length){ fbEl.innerHTML = '<p>No feedback yet.</p>'; return; }
          fbEl.innerHTML = '';
          for(const f of filtered){
            const div = document.createElement('div'); div.className='order';
            const who = f.customer ? (f.customer.Name || f.customer.Email) : f.CustomerID;
            const rest = f.restaurant ? f.restaurant.Name : '';
            div.innerHTML = `<div><strong>Order:</strong> ${escapeHtml(f.OrderID)} <span class="small">(${escapeHtml(f.CreatedAt)})</span></div>
              <div><strong>Customer:</strong> ${escapeHtml(who)}</div>
              <div><strong>Restaurant:</strong> ${escapeHtml(rest)}</div>
              <div><strong>Rating:</strong> ${escapeHtml(f.Rating)}</div>
              <div><strong>Comment:</strong> ${escapeHtml(f.Comment || '')}</div>
              <div style="margin-top:8px"><button class="btn ack-btn" data-feedback-id="${escapeHtml(f.FeedbackID)}">Acknowledge</button></div>`;
            fbEl.appendChild(div);
          }

          // attach acknowledge handlers
          fbEl.querySelectorAll('.ack-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
              const id = e.currentTarget.getAttribute('data-feedback-id');
              if(!confirm('Acknowledge and remove this feedback?')) return;
              const r = await fetch('/api/feedback/' + encodeURIComponent(id), { method: 'DELETE' });
              if(!r.ok){ alert('Failed to remove feedback'); return; }
              // refresh the page so the list stays in sync
              window.location.reload();
            });
          });
        }catch(e){ console.error(e); document.getElementById('feedback-list').innerHTML = '<p>Error loading feedback</p>'; }
      }

      // Append a single active job to the Active Jobs DOM (used for optimistic UI)
      function appendActiveJobToDOM(job){
        try{
          const activeEl = document.getElementById('active-jobs');
          if(!activeEl) return;
          // create job card
          const div = document.createElement('div'); div.className = 'order';
          let itemsHtml = '';
          // show item ids immediately; names will be filled in asynchronously
          for(const it of job.items || []){
            const priceStr = (it.Price||0).toFixed ? (it.Price||0).toFixed(2) : (it.Price||0);
            itemsHtml += `${it.Quantity}× ${it.ItemID} — $${priceStr}<br>`;
          }
          const order = job.order || {};
          const delivery = order.delivery || {};
          div.innerHTML = `<h4>Job ${escapeHtml(job.JobID)} — Order ${escapeHtml(order.OrderID || job.OrderID || '')}</h4>
            <div><strong>Restaurant:</strong> ${order.restaurant ? escapeHtml(order.restaurant.Name) : ''}</div>
            <div><strong>Items:</strong><div class="job-items">${itemsHtml}</div></div>
            <div><strong>Deliver to:</strong> ${escapeHtml(delivery.building || order.DeliveryLocation || '')} ${escapeHtml(delivery.room || '')}</div>
            <div><strong>Instructions:</strong> ${delivery.instructions ? escapeHtml(delivery.instructions) : 'None'}</div>
            <div style="margin-top:0.5rem"><button class="btn js-complete" data-id="${escapeHtml(job.JobID)}">Mark Delivered</button></div>`;
          activeEl.prepend(div);

          // attach complete handler
          div.querySelector('.js-complete').addEventListener('click', async () => {
            const jobId = job.JobID;
            if(!confirm('Confirm you have delivered this order?')) return;
            const r = await fetch(`/api/jobs/${jobId}/complete`, { method: 'POST' });
            if(r.ok){ alert('Job completed.'); await updateWorkerStatus(); await loadActiveJobs(); await loadOrders(); await loadWorkerFeedback(); }
            else alert('Failed to complete job');
          });

          // asynchronously resolve item names
          (async ()=>{
            try{
              const itemsDiv = div.querySelector('.job-items');
              if(!itemsDiv) return;
              let resolved = '';
              for(const it of job.items){
                try{
                  const menuItem = (typeof window.getMenuItem === 'function') ? await window.getMenuItem(it.ItemID) : null;
                  const name = menuItem ? menuItem.Name : it.ItemID;
                  const priceStr = (it.Price||0).toFixed ? (it.Price||0).toFixed(2) : (it.Price||0);
                  resolved += `${it.Quantity}× ${name} — $${priceStr}<br>`;
                }catch(e){ resolved += `${it.Quantity}× ${it.ItemID} — $${it.Price}<br>`; }
              }
              itemsDiv.innerHTML = resolved;
            }catch(e){ console.error('Failed to resolve item names', e); }
          })();
        }catch(e){ console.error('appendActiveJobToDOM error', e); }
      }

      // initial load
        updateWorkerStatus();
      loadOrders();
      loadActiveJobs();
      loadWorkerFeedback();
      maybeCompleteJob();
      // refresh every 15s (also refresh feedback so workers see new feedback promptly)
      setInterval(()=>{ updateWorkerStatus(); loadOrders(); loadActiveJobs(); loadWorkerFeedback(); }, 15000);
    </script>
  </body>
</html>
