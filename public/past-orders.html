<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Past Orders | GritDash</title>
    <link rel="stylesheet" href="homepage-style.css">
    <style>
      .container { max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
      .order { border:1px solid #e0e0e0; padding:1rem; margin-bottom:1rem; border-radius:6px; }
      .order-header { display:flex; justify-content:space-between; align-items:center; }
      .order-items { margin-top:0.5rem; }
      .btn { background:#2b6cb0; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; }
      .small { font-size:0.9rem; color:#666; }
    </style>
  </head>
  <body>
    <header class="nav-bar">
      <div class="header-container">
        <img class="nav-logo" src="./images/gritdash-logo-1.png" alt="GritDash logo">
        <a class="nav-link" href="homepage.html">Home</a>
        <a class="nav-link" href="cart.html">Cart</a>
      </div>
    </header>

    <main class="container">
      <h2>Your Past Orders</h2>
      <div id="orders-area">
        <p id="empty-msg" class="small">Loading your orders...</p>
      </div>
    </main>

    <script src="./scripts/cart-common.js"></script>
    <script>
      async function renderOrders() {
        const area = document.getElementById('orders-area');
        const currentCustomer = localStorage.getItem('current_customer');
        if (!currentCustomer) {
          window.location.href = 'customer-login.html?redirect=past-orders.html';
          return;
        }
        const cust = JSON.parse(currentCustomer);
        const res = await fetch('/api/orders/customer?customerId=' + encodeURIComponent(cust.CustomerID));
        if (!res.ok) {
          area.innerHTML = '<p class="small">Failed to load orders.</p>';
          return;
        }
        const data = await res.json();
        const orders = data.orders || [];
        if (!orders.length) {
          area.innerHTML = '<p class="small">No past orders found.</p>';
          return;
        }
        area.innerHTML = '';
        for (const order of orders) {
          const div = document.createElement('div');
          div.className = 'order';
          const placed = order.OrderID || '';
          const status = order.OrderStatus || '';
          const restaurant = (order.restaurant && order.restaurant.Name) || '';
          const date = new Date(order.OrderID && order.OrderID.split('-')[1] ? parseInt(order.OrderID.split('-')[1],36) : Date.now()).toLocaleString();

          let itemsHtml = '<ul class="order-items">';
          let total = 0;
          for (const it of order.items || []) {
            const price = parseFloat(it.Price || 0) * (it.Quantity || 1);
            total += price;
            itemsHtml += `<li>${(it.Name || it.ItemID)} ${it.Quantity ? '×' + it.Quantity : ''} — $${price.toFixed(2)}</li>`;
          }
          itemsHtml += '</ul>';

          div.innerHTML = `
            <div class="order-header">
              <div>
                <strong>${escapeHtml(restaurant)}</strong>
                <div class="small">Order: ${escapeHtml(placed)} • ${escapeHtml(status)} • ${escapeHtml(date)}</div>
              </div>
              <div style="text-align:right">
                <div class="small">Total: $${total.toFixed(2)}</div>
                <button class="btn feedback-btn" data-order-id="${escapeHtml(placed)}">Leave Feedback</button>
              </div>
            </div>
            ${itemsHtml}
          `;
          area.appendChild(div);
        }

        // attach feedback handlers
        document.querySelectorAll('.feedback-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const orderId = e.currentTarget.getAttribute('data-order-id');
            window.location.href = 'feedback.html?orderId=' + encodeURIComponent(orderId);
          });
        });
      }

      function escapeHtml(text) {
        if (!text) return '';
        return String(text).replace(/[&<>"']/g, function (m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
      }

      renderOrders();
    </script>
  </body>
</html>
