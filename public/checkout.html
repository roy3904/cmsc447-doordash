<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Checkout | GritDash</title>
    <link rel="stylesheet" href="homepage-style.css">
    <script src="https://kit.fontawesome.com/5d92ce3398.js" crossorigin="anonymous"></script>
    <style>
      .checkout-container { max-width: 900px; margin:2rem auto; padding:0 1rem; }
      .summary { border:1px solid #e6e6e6; padding:1rem; border-radius:6px; }
      .summary h3 { margin-top:0; }
      .line-item { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #f0f0f0; }
      .controls { margin-top:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
      .btn { background:#2b6cb0; color:white; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; }
      .input { padding:8px; border:1px solid #ddd; border-radius:4px; width:100%; }
      .modal-backdrop { position:fixed; left:0; right:0; top:0; bottom:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; }
      .modal { background:white; padding:1.5rem; border-radius:6px; max-width:460px; width:90%; }
    </style>
  </head>
  <body>
    <header class="nav-bar">
      <div class="header-container">
        <img class="nav-logo" src="images/gritdash-logo-1.png" alt="GritDash logo">
        <a class="nav-link" href="homepage.html">Home</a>
        <a class="nav-link">Worker Portal</a>
        <a class="nav-link">Admin Portal</a>
      </div>
      <a href="cart.html" aria-label="Cart" id="cart-link" style="color:inherit;text-decoration:none;">
        <i class="fa-solid fa-cart-shopping badge" style="font-size:22px;">
          <span id="cart-count" class="badge-count">0</span>
        </i>
      </a>
    </header>

    <main class="checkout-container">
      <h2>Checkout</h2>
      <div id="empty-warning" style="display:none;color:#666;margin-bottom:1rem;">Your cart is empty. Add items before checking out.</div>

      <div class="summary" id="order-summary">
        <h3>Order Summary</h3>
        <div id="items-list"></div>
        <div class="line-item" style="font-weight:700;">
          <div>Total</div>
          <div id="summary-total">$0.00</div>
        </div>
      </div>

      <div style="margin-top:1rem">
        <label for="building">Delivery Address / Building</label>
        <input id="building" class="input" placeholder="Building name or full address (e.g., Commons, Library, ITE, Engineering, 1000 Hilltop Cir)" />
      </div>

      <div style="margin-top:0.75rem">
        <label for="room">Room / Location (e.g., 2nd floor lounge or Room 123)</label>
        <input id="room" class="input" placeholder="Room, area, or building landmark" />
      </div>

      <div style="margin-top:0.75rem">
        <label for="instructions">Special Instructions (optional)</label>
        <input id="instructions" class="input" placeholder="Leave at reception, call when outside, etc." />
      </div>

      <div style="margin-top:1rem">
        <h4>Payment Method</h4>
        <label><input type="radio" name="payment" value="Card" checked/> Credit / Debit Card</label><br/>
        <label><input type="radio" name="payment" value="Cash"/> Cash on Delivery</label><br/>
        <label><input type="radio" name="payment" value="MealPlan"/> UMBC Meal Plan</label>
      </div>

      <div class="controls">
        <div>
          <label for="tip">Tip (optional)</label>
          <input id="tip" class="input" placeholder="0.00" />
        </div>
        <div style="align-self:end; text-align:right;">
          <button id="place-order" class="btn">Place Order</button>
        </div>
      </div>
    </main>

    <footer>
      <img class="footer-logo" src="images/gritdash-logo-1.png">
    </footer>

    <!-- Confirmation modal -->
    <div id="confirmation" style="display:none" class="modal-backdrop">
      <div class="modal">
        <h3>Order Placed</h3>
        <p id="conf-text"></p>
        <div style="text-align:right;margin-top:1rem"><button id="close-modal" class="btn">Close</button></div>
      </div>
    </div>

    <script>
      const CART_KEY = 'cart';
      const ORDERS_KEY = 'orders';

      function getCart() { try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch(e){ return []; } }
      function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); window.dispatchEvent(new Event('cart_updated')); }
      function getOrders(){ try { return JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]'); } catch(e){ return []; } }
      function saveOrders(o){ localStorage.setItem(ORDERS_KEY, JSON.stringify(o)); }

      function updateBadge(){
        const cart = getCart();
        const count = cart.reduce((s, it) => s + (it.quantity || 1), 0);
        const el = document.getElementById('cart-count');
        if(el) {
          if(count>0) { el.style.display='inline-block'; el.textContent = count; }
          else { el.style.display='none'; }
        }
      }

      function renderSummary(){
        const cart = getCart();
        const list = document.getElementById('items-list');
        const totalEl = document.getElementById('summary-total');
        list.innerHTML = '';
        if(!cart.length){ document.getElementById('empty-warning').style.display='block'; document.getElementById('order-summary').style.display='none'; updateBadge(); return; }
        document.getElementById('empty-warning').style.display='none'; document.getElementById('order-summary').style.display='block';
        let total = 0;
        cart.forEach(item => {
          const price = parseFloat(item.price || 0) * (item.quantity || 1);
          total += price;
          const div = document.createElement('div'); div.className='line-item';
          div.innerHTML = `<div>${escapeHtml(item.restaurant || '')} — ${escapeHtml(item.name || '')}${item.quantity && item.quantity>1? ' ×'+item.quantity:''}</div><div>$${price.toFixed(2)}</div>`;
          list.appendChild(div);
        });
        totalEl.textContent = '$' + total.toFixed(2);
        updateBadge();
      }

      function escapeHtml(text){ return (text||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

      function generateOrderId(){
        // simple unique id using timestamp and random
        return 'ODR-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
      }

      document.getElementById('place-order').addEventListener('click', async () => {
        const cart = getCart();
        if(!cart.length){ alert('Your cart is empty.'); return; }

        const building = document.getElementById('building').value;
        const room = document.getElementById('room').value || '';
        const instructions = document.getElementById('instructions').value || '';
        const tipVal = parseFloat(document.getElementById('tip').value) || 0;
        const payment = document.querySelector('input[name="payment"]:checked').value;

        const totalCost = cart.reduce((total, item) => total + (parseFloat(item.price) * item.quantity), 0) + tipVal;

        const order = {
          id: generateOrderId(),
          customerId: 'CUST-123', // TODO: Fetch Customer ID
          restaurantId: cart[0].restaurantId, // Assuming all items are from the same restaurant
          delivery: { building, room, instructions },
          items: cart.map(it => ({ id: it.id, name: it.name, price: parseFloat(it.price||0), quantity: it.quantity||1 })),
          totalCost: totalCost,
          tip: tipVal,
          paymentMethod: payment,
          status: 'Placed',
        };

        try {
          const response = await fetch('/api/orders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(order)
          });

          if (!response.ok) {
            throw new Error('Failed to place order');
          }

          // clear cart after successful order
          saveCart([]);

          // show confirmation modal
          document.getElementById('conf-text').innerHTML = `Your order <strong>${order.id}</strong> was placed. Estimated delivery: <strong>20-35 minutes</strong> to ${escapeHtml(building)} ${escapeHtml(room)}.`;
          document.getElementById('confirmation').style.display = 'flex';
        } catch (error) {
          console.error('Error placing order:', error);
          alert('There was an error placing your order. Please try again.');
        }
      });

      document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('confirmation').style.display = 'none';
        window.location.href = 'homepage.html';
      });

      // storage sync
      window.addEventListener('storage', (e) => { if(e.key===CART_KEY||e.key===null) renderSummary(); });
      window.addEventListener('cart_updated', renderSummary);

      // init
      updateBadge();
      renderSummary();
    </script>
  </body>
</html>
