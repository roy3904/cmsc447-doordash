<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Checkout | GritDash</title>
    <link rel="stylesheet" href="homepage-style.css">
    <script src="https://kit.fontawesome.com/5d92ce3398.js" crossorigin="anonymous"></script>
  </head>
  <body>
    <header class="nav-bar">
      <div class="header-container">
        <img class="nav-logo" src="./images/gritdash-logo-1.png" alt="GritDash logo">
        <i class="fa-solid fa-bars menu-icon"></i>
        <div class="header-dropdown hidden">
          <a class="dropdown-selection" href="homepage.html">Home</a>
          <a class="dropdown-selection" href="worker-portal.html">Worker Portal</a>
          <a class="dropdown-selection" href="restaurant-staff-portal.html">Restaurant Staff</a>
          <a class="dropdown-selection" href="admin.html">Admin Portal</a>
        </div>
        <a class="nav-link" href="homepage.html">Home</a>
        <a class="nav-link" href="worker-portal.html">Worker Portal</a>
        <a class="nav-link" href="restaurant-staff-portal.html">Restaurant Staff</a>
        <a class="nav-link" href="admin.html">Admin Portal</a>
      </div>
      <a href="cart.html" aria-label="Cart" class="cart-anchor">
        <i class="fa-solid fa-cart-shopping badge"></i>
        <p id="cart-count" class="badge-count">0</p>
      </a>
      <script src="./scripts/cart-common.js"></script>
    </header>

    <main class="checkout-container">
      <p class="checkout-title">Checkout</p>
      <div id="empty-warning" style="display:none;color:#666;margin-bottom:1rem;">Your cart is empty. Add items before checking out.</div>

      <div class="summary" id="order-summary">
        <p class="summary-title">Order Summary</p>
        <div id="items-list"></div>
        <div class="line-item" style="font-weight:700;">
          <p class="total-text">Total</p>
          <p id="summary-total" class="total-text">$0.00</p>
        </div>
      </div>

      <div class="selection-container">
        <label for="building">Delivery Address / Building <p class="error-message js-building-error-message hidden">Please Select a Location!</p></label>
        <select id="building" class="input">
          <option value="" disabled selected>Select building or delivery location</option>
          <option value="Commons">Commons</option>
          <option value="Library">Library</option>
          <option value="ITE">ITE</option>
          <option value="Engineering">Engineering</option>
          <option value="Student Center">Student Center</option>
          <option value="Chesapeake Hall">Chesapeake Hall</option>
          <option value="Harbor Hall">Harbor Hall</option>
          <option value="Susquehanna Hall">Susquehanna Hall</option>
          <option value="Erikson Hall">Erikson Hall</option>
          <option value="Potomac Hall">Potomac Hall</option>
          <option value="Patapsco Hall">Patapsco Hall</option>
          <option value="Terrace Apartments">Terrace Apartments</option>
          <option value="West Hills Apartments">West Hills Apartments</option>
          <option value="Walker Apartments">Walker Apartments</option>
          <option value="Administration">Administration</option>
        </select>
      </div>

      <div class="selection-container">
        <label for="room">Room / Location (e.g., 2nd floor lounge or Room 123)</label>
        <input id="room" class="input" placeholder="Room, area, or building landmark" />
      </div>

      <div class="selection-container">
        <label for="instructions">Special Instructions (optional)</label>
        <input id="instructions" class="input" placeholder="Leave at reception, call when outside, etc." />
      </div>

      <div style="margin-top:1rem">
        <p class="payment-label">Payment Method</p>
        <label><input type="radio" name="payment" value="Card" checked/> Credit / Debit Card</label><br/>
        <label><input type="radio" name="payment" value="Cash"/> Cash on Delivery</label><br/>
        <label><input type="radio" name="payment" value="MealPlan"/> UMBC Meal Plan</label>
      </div>

      <div class="controls">
        <div>
          <label for="tip">Tip (optional)</label>
          <input id="tip" class="input" placeholder="0.00" />
        </div>
        <div style="align-self:end; text-align:right;">
          <button id="place-order" class="btn">Place Order</button>
        </div>
      </div>
    </main>

    <footer>
      <img class="footer-logo" src="./images/gritdash-logo-1.png">
    </footer>

    <!-- Confirmation modal -->
    <div id="confirmation" style="display:none" class="modal-backdrop">
      <div class="modal">
        <h3>Order Placed</h3>
        <p id="conf-text"></p>
        <div style="text-align:right;margin-top:1rem"><button id="close-modal" class="btn">Close</button></div>
      </div>
    </div>

    <script>
      // Use server-backed cart APIs (cart-common.js provides getCart/updateCartBadge/getMenuItem)
      async function updateBadge(){
        if(typeof window.updateCartBadge === 'function'){
          try { await window.updateCartBadge(); } catch(e) { console.error(e); }
          return;
        }
        // fallback: hide badge
        const el = document.getElementById('cart-count'); if(el) el.style.display='none';
      }

      async function renderSummary(){
        const list = document.getElementById('items-list');
        const totalEl = document.getElementById('summary-total');
        list.innerHTML = '';
        try{
          const cart = (typeof window.getCart === 'function') ? await window.getCart() : null;
          if(!cart || !cart.items || cart.items.length === 0){ document.getElementById('empty-warning').style.display='block'; document.getElementById('order-summary').style.display='none'; await updateBadge(); return; }
          document.getElementById('empty-warning').style.display='none'; document.getElementById('order-summary').style.display='block';
          let total = 0;
          // items are OrderItem rows with ItemID, Quantity, Price
          for(const it of cart.items){
            const menuItem = (typeof window.getMenuItem === 'function') ? await window.getMenuItem(it.ItemID) : null;
            const name = menuItem ? menuItem.Name : (it.ItemID || 'Item');
            const price = parseFloat(it.Price || 0) * (it.Quantity || 1);
            total += price;
            const div = document.createElement('div'); div.className='line-item';
            div.innerHTML = `<p class="item-text">${escapeHtml(name)}${it.Quantity && it.Quantity>1? ' Ã—'+it.Quantity:''}</p><p class="item-text">$${price.toFixed(2)}</p>`;
            list.appendChild(div);
          }
          totalEl.textContent = '$' + total.toFixed(2);
          await updateBadge();
        }catch(e){ console.error('Error rendering summary', e); list.innerHTML = '<p>Error loading cart</p>'; }
      }

      function escapeHtml(text){ return (text||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

      function generateOrderId(){
        // simple unique id using timestamp and random
        return 'ODR-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8).toUpperCase();
      }

      document.getElementById('place-order').addEventListener('click', async () => {
        try{
          const cart = (typeof window.getCart === 'function') ? await window.getCart() : null;
          if(!cart || !cart.items || cart.items.length===0){ alert('Your cart is empty.'); return; }
          const building = document.getElementById('building').value;
          if(!building){ alert('Please select a delivery building/location.'); return; }
          const room = document.getElementById('room').value || '';
          const instructions = document.getElementById('instructions').value || '';
          const tipVal = parseFloat(document.getElementById('tip').value) || 0;
          const payment = document.querySelector('input[name="payment"]:checked').value;

          const items = [];
          let total = 0;
          for(const it of cart.items){
            const menuItem = (typeof window.getMenuItem === 'function') ? await window.getMenuItem(it.ItemID) : null;
            const name = menuItem ? menuItem.Name : it.ItemID;
            const priceVal = parseFloat(it.Price || 0);
            items.push({ id: it.ItemID, name, price: priceVal, quantity: it.Quantity });
            total += priceVal * (it.Quantity || 1);
          }
          const totalCost = total + tipVal;

          const order = {
            id: cart.OrderID || generateOrderId(),
            customerId: cart.CustomerID || 'CUST-123',
            restaurantId: cart.RestaurantID,
            delivery: { building, room, instructions },
            items: items,
            totalCost: totalCost,
            tip: tipVal,
            paymentMethod: payment,
            status: 'Placed',
          };

          const response = await fetch('/api/orders', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(order) });
          if(!response.ok) throw new Error('Failed to place order');

          // clear server-side cart
          await fetch('/api/cart', { method: 'DELETE' });
          await updateBadge();

          // show confirmation modal
          document.getElementById('conf-text').innerHTML = `Your order <strong>${order.id}</strong> was placed. Estimated delivery: <strong>20-35 minutes</strong> to ${escapeHtml(building)} ${escapeHtml(room)}.`;
          document.getElementById('confirmation').style.display = 'flex';
        }catch(e){ console.error(e); alert('There was an error placing your order. Please try again.'); }
      });

      document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('confirmation').style.display = 'none';
        window.location.href = 'homepage.html';
      });

      // react to cart updates
      window.addEventListener('cart_updated', renderSummary);
      window.addEventListener('storage', (e) => { if(e.key==='worker_applications' || e.key==='current_worker') renderSummary(); });

      // init
      updateBadge();
      renderSummary();
    </script>

    <script src="scripts/dropdown-menu.js"></script>
  </body>
</html>
